<head>
  <!-- Resources -->
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>
    <script src="heatmap.js"></script>
    <script src="leaflet-heatmap.js"></script>
   
</head>
<body>
  <!-- HTML -->
 <div class="heatmap" id="map-canvas">

  </div>

<!-- Chart code -->
<script id="query">
  function round(event){
    return  [Number(event.properties.userLatitude).toFixed(), Number(event.properties.userLongitude).toFixed()]
  }
  
  function main() {
    return Events({
      from_date: '2016-09-20',
      to_date:   '2016-09-25',
      event_selectors: [{event: "purchase"}]
    })
    .filter(e => e.properties.userLatitude && e.properties.userLongitude)
    .groupBy([round], mixpanel.reducer.count())
    .map(function(e) { 
      return {
        lng: e.key[1], 
        lat: e.key[0], 
        count: e.value,
      } 
    })
  }
</script>
<script>

var baseLayer = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '...',
    maxZoom: 18
  }
);

var cfg = {
  // radius should be small ONLY if scaleRadius is true (or small radius is intended)
  // if scaleRadius is false it will be the constant radius used in pixels
  "radius": 2,
  "maxOpacity": .8, 
  // scales the radius based on map zoom
  "scaleRadius": true, 
  // if set to false the heatmap uses the global maximum for colorization
  // if activated: uses the data maximum within the current map boundaries 
  //   (there will always be a red spot with useLocalExtremas true)
  "useLocalExtrema": true,
  // which field name in your data represents the latitude - default "lat"
  latField: 'lat',
  // which field name in your data represents the longitude - default "lng"
  lngField: 'lng',
  // which field name in your data represents the data value - default "value"
  valueField: 'count'
};


var heatmapLayer = new HeatmapOverlay(cfg);

  var testData = {
    max: 8,
    data: [{lat: 24.6408, lng:46.7728, count: 3},{lat: 50.75, lng:-1.55, count: 1}, ...]
  };
  var map = new L.Map('map-canvas', {
    center: new L.LatLng(25.6586, -80.3568),
    zoom: 4,
    layers: [baseLayer, heatmapLayer]
  });
  heatmapLayer.setData(testData)
  var query = $('#query').html()
  // MP.api.jql(query).done(function(data){
  //   debugger
  //   var max = 0
  //   _.each(data,function(val){
  //     if ( val.count > max ) max = val.count
  //   })
  //   heatmapLayer.setData({max: max, data:data})
  // })


</script>


</body>